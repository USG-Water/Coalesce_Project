fileVersion: 1
id: e4fdd8c6-0390-414c-80cd-c1608acc7f61
name: STG_TAM_LOCATIONS
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: USG_STG_MASTER
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 65917889-6989-475b-a05f-02ba30990c10
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: ACCOUNT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a1428df-e604-4721-ab85-b6236dc414e3
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f09f8ce-f669-45bc-8bf6-ef097abf515c
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: EBS_CUSTOMER_SITE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7635be0a-0d18-4269-a636-4ff69ecf4c64
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c0261646-6851-43a0-b27b-d6a00e30c778
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: TUM_PROJECT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f43e1f8c-9147-4c97-9801-c8a692372254
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 30e816bf-bdb1-4bf7-9c25-8fadc6710004
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: SERVICE_CENTER_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ccde115-f8ff-4c0c-afc4-1ce39e98fe75
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17642d19-4859-4b61-8640-c6e7993cfe2c
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: ACCOUNT_OWNER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ec52f943-7d45-43da-b3ce-c1e393d90f4b
                stepCounter: e06a4544-2840-4718-ad43-831b10421819
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a6df1968-bd6c-4a34-ac33-53a6db0967e2
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: PWSID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c45a116c-f9a4-45ab-8a39-26ded05857dd
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7094329f-b3e4-485b-9c53-8db0deda87d3
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: SERVICE_AREA_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e99946f4-e05c-434c-9363-4a3ffc8235c5
                stepCounter: 1ab00b2d-c6dd-4c91-89dc-9b0562207a71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 310221fa-4c25-4306-9e0a-0700cc0dc2da
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: FNC_FIPS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 44e4e44a-b230-447f-9233-25f12d498e55
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dd072853-c465-4415-b461-fb02f47c5f7a
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: CITYLITICS_LEAD_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a88ba579-db9d-4169-bab2-54911c5a9adb
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 76e51ed1-99df-454f-8915-1c63b571a25b
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: FNC_FIPS_CITYLITICS_LEAD_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."FNC_FIPS" IS NULL AND "STG_TAM_LOCATIONS_UNION"."CITYLITICS_LEAD_ID" IS NULL THEN NULL
                  ELSE CONCAT(COALESCE("STG_TAM_LOCATIONS_UNION"."FNC_FIPS"::VARCHAR, ''), '|', COALESCE("STG_TAM_LOCATIONS_UNION"."CITYLITICS_LEAD_ID"::VARCHAR, ''))
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f12de578-bc92-4075-9d2f-45825c0f9edc
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: CHURNED_TUM_PROJECT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e15e4ff1-1cf9-448e-807e-50ed36069b35
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e7bd2a5-fb23-4048-8bd9-206366b8bc57
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: CHURNED_LAST_BILLING_YEAR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a9c857c9-2b39-4ee8-9ddf-08d017139342
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 721b6755-7f92-4879-8253-45d9c3815761
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: OSC_OPEN_OPTY_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 93b4b392-fa35-43f2-8207-ce5f6ac47a60
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f804dc00-88b3-4c0d-ba4e-da0c76c0b48f
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: CURRENT_STAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 419d9b58-ec6f-43b1-8a15-24c21128f597
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b349fc4-2110-4215-909c-67a9489f4e5b
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: NUMBER(18,0)
        description: ""
        name: FACILITY_STORAGE_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9ff27925-ae0b-4b45-9a86-d975c1d0aec8
                stepCounter: 1ab00b2d-c6dd-4c91-89dc-9b0562207a71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ad660bde-ca31-423d-ad27-02c5a8860bd5
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: ADDRESS_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a9448c7c-975f-42c9-93b7-1b4c17659ec4
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17ed1469-e30d-40a5-85f3-15e817484a0d
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: ADDRESS_1
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 89e7653c-d89c-446b-9d49-b7191f04ba23
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN NULL
                  ELSE "STG_TAM_LOCATIONS_UNION"."ADDRESS_1"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: db9e0a91-3f3a-4929-beda-36002f453a6b
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(16384)
        description: ""
        name: CITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 924eaab1-ce5f-4311-b753-3d3a73a6db51
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN COALESCE("STG_TAM_LOCATIONS_UNION"."CITY", STG_US_CENSUS_PLACE."CITY")
                  ELSE "STG_TAM_LOCATIONS_UNION"."CITY"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2a99044f-c96e-44de-bc7b-1df9b4443853
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: POSTAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 24085d36-65bd-40d7-817c-599b0814152f
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN NULL
                  ELSE "STG_TAM_LOCATIONS_UNION"."POSTAL_CODE"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ccbc0f5-961f-4022-aca9-5dc42cdda748
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR(256)
        description: ""
        name: STATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cbbc6713-f0b0-49af-905c-31e4874df473
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1c4797c4-40d2-46d9-b346-070d2c476f35
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: FLOAT
        description: ""
        name: LATITUDE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 26acabfe-8cf7-4d7a-9386-b265c97e87b9
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN COALESCE("STG_FNC_LOCATIONS"."LATITUDE", "STG_US_CENSUS_PLACE"."LATITUDE")
                  ELSE "STG_TAM_LOCATIONS_UNION"."LATITUDE"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 047a1340-fb6f-4dfb-aebf-b9314f1a8968
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: FLOAT
        description: ""
        name: LONGITUDE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d6155520-d35b-4c6d-be20-30c21146eba0
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN COALESCE("STG_FNC_LOCATIONS"."LONGITUDE", "STG_US_CENSUS_PLACE"."LONGITUDE")
                  ELSE "STG_TAM_LOCATIONS_UNION"."LONGITUDE"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 04cdea37-9656-4f4c-b997-cc45114bb389
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: POINT_GRANULARITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e3d1d24e-b1bc-44b1-8b4c-fd6d886a226a
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN 'Municipality'
                  ELSE "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b11f6fdb-f54b-408b-bc27-743981e97c2d
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: FULL_ADDRESS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2868cfea-2579-4e3a-8baf-838725975bdd
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: |-
              CASE
                  WHEN "STG_TAM_LOCATIONS_UNION"."POINT_GRANULARITY" = 'Zipcode' THEN CONCAT_WS(', ', COALESCE("STG_TAM_LOCATIONS_UNION"."CITY", STG_US_CENSUS_PLACE."CITY"), "STG_TAM_LOCATIONS_UNION"."STATE")
                  ELSE "STG_TAM_LOCATIONS_UNION"."FULL_ADDRESS"
              END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d68fa28a-96dc-4e9e-9524-268109a44578
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: MAP_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5c474621-add9-4e5a-8ca4-69b987f1d9df
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b64acba8-8a0a-4cfd-892b-d29650d2b522
          stepCounter: e4fdd8c6-0390-414c-80cd-c1608acc7f61
        config: {}
        dataType: VARCHAR
        description: ""
        name: STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 12e397af-90bf-4379-be82-8086f12372df
                stepCounter: 21e36a45-5a1e-453f-b5fd-a08e788452b6
            transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          STG_ACCOUNTS: e06a4544-2840-4718-ad43-831b10421819
          STG_FNC_LOCATIONS: 540c95c4-d5b5-41c2-9d47-55e8d100fd34
          STG_TAM_LOCATIONS_UNION: 21e36a45-5a1e-453f-b5fd-a08e788452b6
          STG_TAM_PUBLIC_WATER_SYSTEM_BOUNDARIES: 1ab00b2d-c6dd-4c91-89dc-9b0562207a71
          STG_US_CENSUS_PLACE: 6a7e57a4-c322-416c-b31a-3806c044a572
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: USG_STG_FISCAL_NOTE_CURATE
            nodeName: STG_FNC_LOCATIONS
          - locationName: USG_STG_MASTER
            nodeName: STG_ACCOUNTS
          - locationName: USG_STG_MASTER
            nodeName: STG_TAM_LOCATIONS_UNION
          - locationName: USG_STG_MASTER
            nodeName: STG_TAM_PUBLIC_WATER_SYSTEM_BOUNDARIES
          - locationName: USG_STG_MASTER
            nodeName: STG_US_CENSUS_PLACE
        join:
          joinCondition: |-
            FROM {{ ref('USG_STG_MASTER', 'STG_TAM_LOCATIONS_UNION') }} "STG_TAM_LOCATIONS_UNION"
            LEFT JOIN {{ ref('USG_STG_MASTER', 'STG_TAM_PUBLIC_WATER_SYSTEM_BOUNDARIES') }} "STG_TAM_PUBLIC_WATER_SYSTEM_BOUNDARIES"
                ON "STG_TAM_LOCATIONS_UNION"."PWSID" = "STG_TAM_PUBLIC_WATER_SYSTEM_BOUNDARIES"."PWSID"
            LEFT JOIN {{ ref('USG_STG_MASTER', 'STG_ACCOUNTS') }} "STG_ACCOUNTS"
                ON "STG_TAM_LOCATIONS_UNION"."ACCOUNT_ID" = "STG_ACCOUNTS"."ACCOUNT_ID"
            LEFT JOIN {{ ref('USG_STG_FISCAL_NOTE_CURATE', 'STG_FNC_LOCATIONS') }} "STG_FNC_LOCATIONS"
                ON "STG_TAM_LOCATIONS_UNION"."FNC_FIPS" = "STG_FNC_LOCATIONS"."FIPS"
            LEFT JOIN {{ ref('USG_STG_MASTER', 'STG_US_CENSUS_PLACE') }} "STG_US_CENSUS_PLACE"
                ON "STG_TAM_LOCATIONS_UNION"."STATE" = "STG_US_CENSUS_PLACE"."STATE"
                AND (
                    -- exact city name first
                    "STG_TAM_LOCATIONS_UNION"."CITY" = "STG_US_CENSUS_PLACE"."CITY"
                    -- or nearest coordinates within 25 km
                    OR ST_DWITHIN(
                        ST_MAKEPOINT("STG_TAM_LOCATIONS_UNION"."LONGITUDE", "STG_TAM_LOCATIONS_UNION"."LATITUDE"),
                        "STG_US_CENSUS_PLACE"."COORDINATES",
                        25000 --25km
                    )
                )
            WHERE "STG_TAM_LOCATIONS_UNION"."STATE" IN (
                'AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA',
                'ID','IL','IN','IA','KS','KY','LA','ME','MD',
                'MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ',
                'NM','NY','NC','ND','OH','OK','OR','PA','RI','SC',
                'SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'
            )
            QUALIFY ROW_NUMBER() OVER (
                PARTITION BY "STG_TAM_LOCATIONS_UNION"."ACCOUNT_ID"
                             , "STG_TAM_LOCATIONS_UNION"."EBS_CUSTOMER_SITE_ID"
                             , "STG_TAM_LOCATIONS_UNION"."PWSID"
                             , "STG_TAM_LOCATIONS_UNION"."FNC_FIPS"
                             , "STG_TAM_LOCATIONS_UNION"."SERVICE_CENTER_NAME"
                ORDER BY
                    CASE WHEN "STG_TAM_LOCATIONS_UNION"."CITY" = "STG_US_CENSUS_PLACE"."CITY" THEN 0 ELSE 1 END, -- prefer exact name
                    ST_DISTANCE(
                        ST_MAKEPOINT("STG_TAM_LOCATIONS_UNION"."LONGITUDE", "STG_TAM_LOCATIONS_UNION"."LATITUDE"),
                        "STG_US_CENSUS_PLACE"."COORDINATES"
                    )
            ) = 1
        name: STG_TAM_LOCATIONS
        noLinkRefs: []
  name: STG_TAM_LOCATIONS
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
