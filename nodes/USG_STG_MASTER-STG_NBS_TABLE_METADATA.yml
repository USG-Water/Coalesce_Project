fileVersion: 1
id: b06afb29-ed1f-40ed-bfda-9edc76ddad81
name: STG_NBS_TABLE_METADATA
operation:
  config:
    insertStrategy: INSERT
    postSQL: |-
      {% set full_ref = ref('USG_STG_MASTER', 'STG_NBS_TABLE_METADATA') | replace('"','') %}
      {% set parts = full_ref.split('.') %}
      {% set meta_db = parts[0] %}
      {% set meta_schema = parts[1] %}
      {% set meta_table = parts[2] %}

      CREATE OR REPLACE PROCEDURE {{ meta_db }}.{{ meta_schema }}.SP_NBS_LATEST_MONTH_PER_YEAR()
      RETURNS STRING
      LANGUAGE SQL
      EXECUTE AS CALLER
      AS
      $$
      DECLARE
          v_sql STRING;
      BEGIN

          /* 1) Select latest month per year */
          WITH latest_per_year AS (
              SELECT
                  TABLE_CATALOG,
                  TABLE_SCHEMA,
                  TABLE_NAME,
                  YEAR_NUM,
                  MONTH_NUM
              FROM {{ meta_db }}.{{ meta_schema }}.{{ meta_table }}
              QUALIFY MONTH_NUM = MAX(MONTH_NUM) OVER (PARTITION BY YEAR_NUM)
          )

          /* 2) Build UNION ALL SQL (VARIANT-safe) */
          SELECT LISTAGG(
                   'SELECT ' ||
                     YEAR_NUM || ' AS YEAR_NUM, ' ||
                     MONTH_NUM || ' AS MONTH_NUM, ' ||
                     'TO_DATE(''' || YEAR_NUM || '-' || LPAD(MONTH_NUM,2,'0') || '-01'') AS AS_OF_MONTH, ' ||
                     'OBJECT_CONSTRUCT_KEEP_NULL(*) AS ROW_DATA ' ||
                   'FROM ' || TABLE_CATALOG || '.' || TABLE_SCHEMA || '.' || TABLE_NAME || ' t',
                   ' UNION ALL '
                 ) WITHIN GROUP (ORDER BY YEAR_NUM)
            INTO :v_sql
          FROM latest_per_year;

          IF (v_sql IS NULL) THEN
              RETURN 'No tables found in STG_NBS_TABLE_METADATA';
          END IF;

          /* 3) Create / replace final view */
          EXECUTE IMMEDIATE
              'CREATE OR REPLACE VIEW {{ meta_db }}.{{ meta_schema }}.STG_NBS_FINANCE_AUTOMATED AS ' || v_sql;

          RETURN '{{ meta_db }}.{{ meta_schema }}.STG_NBS_FINANCE_AUTOMATED refreshed successfully';

      END;
      $$;
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: The tables defined in this database that are accessible to the current user's role.
  isMultisource: false
  locationName: USG_STG_MASTER
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8dae05d8-5c37-4cec-892e-7a71ec8ff1f9
          stepCounter: b06afb29-ed1f-40ed-bfda-9edc76ddad81
        config: {}
        dataType: VARCHAR
        description: Name of the table
        name: TABLE_CATALOG
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 19de4e09-fad0-44ef-a827-05a5099e7d00
                stepCounter: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5093cf50-40dd-447b-9206-5f865fd8ba6c
          stepCounter: b06afb29-ed1f-40ed-bfda-9edc76ddad81
        config: {}
        dataType: VARCHAR
        description: Name of the table
        name: TABLE_SCHEMA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e3c45d3-ba52-4fad-838a-097815b96332
                stepCounter: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 68ef35a7-d2d3-4a21-a7b3-b64f948024d6
          stepCounter: b06afb29-ed1f-40ed-bfda-9edc76ddad81
        config: {}
        dataType: VARCHAR
        description: Name of the table
        name: TABLE_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 69f33f79-1e09-464b-b66e-223c0fef3d81
                stepCounter: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
            transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 41bf26e9-18b3-49c6-a763-9b6788a39fbc
          stepCounter: b06afb29-ed1f-40ed-bfda-9edc76ddad81
        config: {}
        dataType: NUMBER
        defaultValue: ""
        description: ""
        keyColumnType: None
        name: MONTH_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 69f33f79-1e09-464b-b66e-223c0fef3d81
                stepCounter: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
            transform: |-
              CASE 
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'JAN.*') THEN 1
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'FEB.*') THEN 2
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'MAR.*') THEN 3
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'APR.*') THEN 4
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'MAY.*') THEN 5
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'JUN.*') THEN 6
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'JUL.*') THEN 7
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'AUG.*') THEN 8
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'SE.*') THEN 9
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'OCT.*') THEN 10
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'NOV.*') THEN 11
                  WHEN REGEXP_LIKE("TABLES"."TABLE_NAME", 'DEC.*') THEN 12
              END
        systemColumnType: None
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9e8b1a73-4480-431d-8013-93be0d7eac67
          stepCounter: b06afb29-ed1f-40ed-bfda-9edc76ddad81
        config: {}
        dataType: NUMBER
        description: ""
        name: YEAR_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 69f33f79-1e09-464b-b66e-223c0fef3d81
                stepCounter: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
            transform: |-
              CASE
                  WHEN REGEXP_LIKE(TABLE_NAME, '.*(19|20)[0-9]{2}.*') THEN TRY_TO_NUMBER(REGEXP_SUBSTR(TABLE_NAME, '(19|20)[0-9]{2}'))
                  WHEN REGEXP_LIKE(TABLE_NAME, '.*_[0-9]{2}_NBS.*') THEN 2000 + TRY_TO_NUMBER(REGEXP_SUBSTR(TABLE_NAME, '_([0-9]{2})_NBS', 1, 1, 'e'))
              END
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          TABLES: 49b68e8a-355c-499d-a92d-c0cfc6e87d18
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: USG_RAW_INFORMATION_SCHEMA
            nodeName: TABLES
        join:
          joinCondition: |-
            FROM {{ ref('USG_RAW_INFORMATION_SCHEMA', 'TABLES') }} "TABLES"
            WHERE "TABLES"."TABLE_TYPE" = 'BASE TABLE'
                  AND "TABLES"."TABLE_SCHEMA" = 'USGSHAREPOINTSALES'
                  AND "TABLES"."TABLE_NAME" ILIKE '%_YTD_NBS%'
        name: STG_NBS_TABLE_METADATA
        noLinkRefs: []
  name: STG_NBS_TABLE_METADATA
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
