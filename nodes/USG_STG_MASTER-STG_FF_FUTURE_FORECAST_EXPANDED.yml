fileVersion: 1
id: c2dd8608-69b8-48d0-ba12-17049bf90fea
name: STG_FF_FUTURE_FORECAST_EXPANDED
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: USG_STG_MASTER
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc376248-bf5d-4fc3-bf47-2e150fd519e8
          stepCounter: c2dd8608-69b8-48d0-ba12-17049bf90fea
        config: {}
        dataType: NUMBER
        description: ""
        name: ADJUSTED_START_YEAR
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d7645249-2688-4995-ba45-44a28c8ee53a
          stepCounter: c2dd8608-69b8-48d0-ba12-17049bf90fea
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        name: TASK_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1f2fd2d6-eef6-43a8-b3d1-606e18bf0099
          stepCounter: c2dd8608-69b8-48d0-ba12-17049bf90fea
        config: {}
        dataType: VARCHAR
        description: ""
        name: TASK_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          STG_FF_FUTURE_FORECAST_ADJUSTED: 27f8a393-866c-4cc7-80e9-4d64aaaaa105
        customSQL:
          customSQL: |-
            {{ stage('Override Create SQL') }}
            	CREATE OR REPLACE VIEW {{ ref('USG_STG_MASTER', 'STG_FF_FUTURE_FORECAST_EXPANDED')}} AS (
            	WITH BASE_COUNTS AS (
            		SELECT ADJUSTED_START_YEAR
            			, COUNT(*) AS BASE_TASK_COUNT
            			, ROUND(COUNT(*) / 0.7, 0) AS TARGET_TASK_COUNT
            		FROM {{ ref('USG_STG_MASTER', 'STG_FF_FUTURE_FORECAST_ADJUSTED') }}
            		GROUP BY ADJUSTED_START_YEAR
            		ORDER BY ADJUSTED_START_YEAR
            	)
            	, RANKED AS (
            		SELECT ADJUSTED_START_YEAR
            			, TASK_ID
            			, TASK_NAME
            			, DATE_CONTRACT_OBLIGATION
            			, PRIORITY_WEIGHT
            			, ROW_NUMBER() OVER (
            					PARTITION BY ADJUSTED_START_YEAR
            					ORDER BY DATE_CONTRACT_OBLIGATION DESC, PRIORITY_WEIGHT DESC
            			) AS YEAR_RANK
            		FROM {{ ref('USG_STG_MASTER', 'STG_FF_FUTURE_FORECAST_ADJUSTED') }}
            	)
            	, EXPANDED AS (
            		SELECT RANKED.ADJUSTED_START_YEAR
            			, RANKED.TASK_ID
            			, RANKED.TASK_NAME
            		FROM RANKED
            		INNER JOIN BASE_COUNTS
            			ON RANKED.ADJUSTED_START_YEAR = BASE_COUNTS.ADJUSTED_START_YEAR
            		WHERE RANKED.YEAR_RANK <= BASE_COUNTS.BASE_TASK_COUNT

            		UNION ALL

            		SELECT BASE_COUNTS.ADJUSTED_START_YEAR
            			, RANKED.TASK_ID
            			, RANKED.TASK_NAME
            		FROM RANKED
            		INNER JOIN BASE_COUNTS
            			ON RANKED.ADJUSTED_START_YEAR = BASE_COUNTS.ADJUSTED_START_YEAR + 1
            		WHERE RANKED.DATE_CONTRACT_OBLIGATION = FALSE
            		AND RANKED.YEAR_RANK <= (BASE_COUNTS.TARGET_TASK_COUNT - BASE_COUNTS.BASE_TASK_COUNT)
            	)
            	SELECT ADJUSTED_START_YEAR
            		, TASK_ID
            		, TASK_NAME
            	FROM EXPANDED
            	ORDER BY ADJUSTED_START_YEAR, TASK_ID
            )
        dependencies:
          - locationName: USG_STG_MASTER
            nodeName: STG_FF_FUTURE_FORECAST_ADJUSTED
        join:
          joinCondition: FROM {{ ref('USG_STG_MASTER', 'STG_FF_FUTURE_FORECAST_ADJUSTED') }} "STG_FF_FUTURE_FORECAST_ADJUSTED"
        name: STG_FF_FUTURE_FORECAST_EXPANDED
        noLinkRefs: []
  name: STG_FF_FUTURE_FORECAST_EXPANDED
  overrideSQL: true
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
